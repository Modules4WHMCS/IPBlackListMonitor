!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./jquery.fmatter","./grid.common"],e):"object"==typeof module&&module.exports?module.exports=function(l,t){return l||(l=window),void 0===t&&(t="undefined"!=typeof window?require("jquery"):require("jquery")(l)),require("./grid.base"),require("./jquery.fmatter"),require("./grid.common"),e(t),t}:e(jQuery)}(function(e){"use strict";var l=e.jgrid,t=function(){var t=e.makeArray(arguments);return t.unshift(""),t.unshift(""),t.unshift(this.p),l.feedback.apply(this,t)},i=function(l,t){var i=this.grid.fbRows;return e((null!=i&&i[0].cells.length>t?i[l.rowIndex]:l).cells[t])};l.extend({editCell:function(r,a,d){return this.each(function(){var o,n,s,c,u=this,f=e(u),h=u.p,p=u.rows;if(u.grid&&!0===h.cellEdit&&null!=p&&null!=p[r]&&(r=parseInt(r,10),a=parseInt(a,10),!isNaN(r)&&!isNaN(a))){var v,C=p[r],m=null!=C?C.id:null,g=e(C),j=parseInt(h.iCol,10),b=parseInt(h.iRow,10),q=e(p[b]),w=h.savedRow;if(null!=m){if(h.selrow=m,h.knv||f.jqGrid("GridNav"),w.length>0){if(!0===d&&r===b&&a===j)return;f.jqGrid("saveCell",w[0].id,w[0].ic)}else setTimeout(function(){e("#"+l.jqID(h.knv)).attr("tabindex","-1").focus()},1);if(c=h.colModel[a],"subgrid"!==(o=c.name)&&"cb"!==o&&"rn"!==o){s=i.call(u,C,a);var G=c.editable;e.isFunction(G)&&(G=G.call(u,{rowid:m,iCol:a,iRow:r,cmName:o,cm:c,mode:"cell"}));var y=f.jqGrid("getGuiStyles","states.select","edit-cell"),x=f.jqGrid("getGuiStyles","states.hover","selected-row");if(!0!==G||!0!==d||s.hasClass("not-editable-cell"))j>=0&&b>=0&&(i.call(u,q[0],j).removeClass(y),q.removeClass(x)),s.addClass(y),g.addClass(x),n=s.html().replace(/&#160;/gi,""),t.call(u,"onSelectCell",m,o,n,r,a);else{j>=0&&b>=0&&(i.call(u,q[0],j).removeClass(y),q.removeClass(x)),s.addClass(y),g.addClass(x),c.edittype||(c.edittype="text"),v=c.edittype;try{n=e.unformat.call(u,s,{rowId:m,colModel:c},a)}catch(e){n="textarea"===v?s.text():s.html()}if(h.autoEncodeOnEdit&&(n=l.oldDecodePostedData(n)),("&nbsp;"===n||"&#160;"===n||1===n.length&&160===n.charCodeAt(0))&&(n=""),e.isFunction(h.formatCell)){var k=h.formatCell.call(u,m,o,n,r,a);void 0!==k&&(n=k)}t.call(u,"beforeEditCell",m,o,n,r,a),w.push({id:r,ic:a,name:o,v:n}),h.editingInfo[m]={mode:"cellEditing",savedRow:w[w.length-1],editable:{}},h.editingInfo[m].editable[o]=G;var E=e.extend({},c.editoptions||{},{id:r+"_"+o,name:o,rowId:m,mode:"cell",cm:c,iCol:a}),R=l.createEl.call(u,v,E,n,!0,e.extend({},l.ajaxOptions,h.ajaxSelectOptions||{})),S=s,I=!0===h.treeGrid&&o===h.ExpandColumn;I&&(S=s.children("span.cell-wrapperleaf,span.cell-wrapper")),S.html("").append(R).attr("tabindex","0"),I&&e(R).width(s.width()-s.children("div.tree-wrap").outerWidth()),l.bindEv.call(u,R,E),setTimeout(function(){e(R).focus()},1),e("input, select, textarea",s).on("keydown",function(l){if(27===l.keyCode&&(e("input.hasDatepicker",s).length>0?e(".ui-datepicker").is(":hidden")?f.jqGrid("restoreCell",r,a):e("input.hasDatepicker",s).datepicker("hide"):f.jqGrid("restoreCell",r,a)),13===l.keyCode&&!l.shiftKey)return f.jqGrid("saveCell",r,a),!1;if(9===l.keyCode){if(u.grid.hDiv.loading)return!1;l.shiftKey?f.jqGrid("prevCell",r,a):f.jqGrid("nextCell",r,a)}l.stopPropagation()}),t.call(u,"afterEditCell",m,o,n,r,a)}h.iCol=a,h.iRow=r}}}})},saveCell:function(r,a){return this.each(function(){var d=this,o=e(d),n=d.p,s=d.grid,c=l.info_dialog,u=l.jqID;if(s&&!0===n.cellEdit){var f=o.jqGrid("getGridRes","errors"),h=f.errcap,p=o.jqGrid("getGridRes","edit").bClose,v=n.savedRow,C=v.length>=1?0:null;if(null!==C){var m,g=d.rows[r],j=g.id,b=e(g),q=n.colModel[a],w=q.name,G=i.call(d,g,a),y={},x=l.getEditedValue.call(d,G,q,y);if(x!==v[C].v){void 0!==(m=o.triggerHandler("jqGridBeforeSaveCell",[j,w,x,r,a]))&&(x=m),e.isFunction(n.beforeSaveCell)&&void 0!==(m=n.beforeSaveCell.call(d,j,w,x,r,a))&&(x=m);var k=l.checkValues.call(d,x,a,void 0,void 0,{oldValue:v[C].v,newValue:x,cmName:w,rowid:j,iCol:a,iRow:r,cm:q,tr:g,td:G,mode:"cell"}),E=q.formatoptions||{};if(null==k||!0===k||!0===k[0]){var R=o.triggerHandler("jqGridBeforeSubmitCell",[j,w,x,r,a])||{};if(e.isFunction(n.beforeSubmitCell)&&((R=n.beforeSubmitCell.call(d,j,w,x,r,a))||(R={})),e("input.hasDatepicker",G).length>0&&e("input.hasDatepicker",G).datepicker("hide"),"date"===q.formatter&&!0!==E.sendFormatted&&(x=e.unformat.date.call(d,x,q)),"remote"===n.cellsubmit)if(n.cellurl){var S={};S[w]=x;var I=n.prmNames,D=I.id,F=I.oper;S[D]=l.stripPref(n.idPrefix,j),S[F]=I.editoper,S=e.extend(R,S),n.autoEncodeOnEdit&&e.each(S,function(t,i){e.isFunction(i)||(S[t]=l.oldEncodePostedData(i))}),o.jqGrid("progressBar",{method:"show",loadtype:n.loadui,htmlcontent:o.jqGrid("getGridRes","defaults.savetext")||"Saving..."}),s.hDiv.loading=!0,e.ajax(e.extend({url:e.isFunction(n.cellurl)?n.cellurl.call(d,n.cellurl,r,a,j,x,w):n.cellurl,data:l.serializeFeedback.call(d,n.serializeCellData,"jqGridSerializeCellData",S),type:"POST",complete:function(l){if(s.endReq.call(d),(l.status<300||304===l.status)&&(0!==l.status||4!==l.readyState)){var i=o.triggerHandler("jqGridAfterSubmitCell",[d,l,S.id,w,x,r,a])||[!0,""];(!0===i||!0===i[0]&&e.isFunction(n.afterSubmitCell))&&(i=n.afterSubmitCell.call(d,l,S.id,w,x,r,a)),null==i||!0===i||!0===i[0]?(o.jqGrid("setCell",j,a,x,!1,!1,!0),G.addClass("dirty-cell"),b.addClass("edited"),t.call(d,"afterSaveCell",j,w,x,r,a),v.splice(0,1),delete n.editingInfo[j]):(c.call(d,h,i[1],p),o.jqGrid("restoreCell",r,a))}},error:function(l,t,i){o.triggerHandler("jqGridErrorCell",[l,t,i]),e.isFunction(n.errorCell)?(n.errorCell.call(d,l,t,i),o.jqGrid("restoreCell",r,a)):(c.call(d,h,l.status+" : "+l.statusText+"<br/>"+t,p),o.jqGrid("restoreCell",r,a))}},l.ajaxOptions,n.ajaxCellOptions||{}))}else try{c.call(d,h,f.nourl,p),o.jqGrid("restoreCell",r,a)}catch(e){}"clientArray"===n.cellsubmit&&(o.jqGrid("setCell",j,a,"select"===q.edittype&&"select"!==q.formatter?y.text:x,!1,!1,!0),G.addClass("dirty-cell"),b.addClass("edited"),t.call(d,"afterSaveCell",j,w,x,r,a),v.splice(0,1),delete n.editingInfo[j])}else try{setTimeout(function(){var t=l.getRelativeRect.call(d,G);c.call(d,h,x+" "+k[1],p,{top:t.top,left:t.left+e(d).closest(".ui-jqgrid").offset().left})},50),o.jqGrid("restoreCell",r,a)}catch(e){}}else o.jqGrid("restoreCell",r,a)}setTimeout(function(){e("#"+u(n.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(l,r){return this.each(function(){var a,d,o,n=this,s=n.p,c=n.rows[l],u=c.id;if(n.grid&&!0===s.cellEdit){var f=s.savedRow,h=i.call(n,c,r);if(f.length>=1){if(e.isFunction(e.fn.datepicker))try{e("input.hasDatepicker",h).datepicker("hide")}catch(e){}d=s.colModel[r],!0===s.treeGrid&&d.name===s.ExpandColumn?h.children("span.cell-wrapperleaf,span.cell-wrapper").empty():h.empty(),h.attr("tabindex","-1"),a=f[0].v,o=d.formatoptions||{},"date"===d.formatter&&!0!==o.sendFormatted&&(a=e.unformat.date.call(n,a,d)),e(n).jqGrid("setCell",u,r,a,!1,!1,!0),t.call(n,"afterRestoreCell",u,a,l,r),f.splice(0,1),delete s.editingInfo[u]}setTimeout(function(){e("#"+s.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(l,t){return this.each(function(){var i,r,a,d=this,o=e(d),n=d.p,s=!1,c=d.rows;if(d.grid&&!0===n.cellEdit&&null!=c&&null!=c[l]){for(i=t+1;i<n.colModel.length;i++)if(a=n.colModel[i],r=a.editable,e.isFunction(r)&&(r=r.call(d,{rowid:c[l].id,iCol:i,iRow:l,cmName:a.name,cm:a,mode:"cell"})),!0===r){s=i;break}!1!==s?o.jqGrid("editCell",l,s,!0):n.savedRow.length>0&&o.jqGrid("saveCell",l,t)}})},prevCell:function(l,t){return this.each(function(){var i,r,a,d=this,o=e(d),n=d.p,s=!1,c=d.rows;if(d.grid&&!0===n.cellEdit&&null!=c&&null!=c[l]){for(i=t-1;i>=0;i--)if(a=n.colModel[i],r=a.editable,e.isFunction(r)&&(r=r.call(d,{rowid:c[l].id,iCol:i,iRow:l,cmName:a.name,cm:a,mode:"cell"})),!0===r){s=i;break}!1!==s?o.jqGrid("editCell",l,s,!0):n.savedRow.length>0&&o.jqGrid("saveCell",l,t)}})},GridNav:function(){return this.each(function(){function l(e,l,t){var i=a.rows[e];if("v"===t.substr(0,1)){var r=s.clientHeight,d=s.scrollTop,o=i.offsetTop+i.clientHeight,n=i.offsetTop;"vd"===t&&o>=r&&(s.scrollTop=s.scrollTop+i.clientHeight),"vu"===t&&n<d&&(s.scrollTop=s.scrollTop-i.clientHeight)}if("h"===t){var c=s.clientWidth,u=s.scrollLeft,f=i.cells[l],h=f.offsetLeft+f.clientWidth,p=f.offsetLeft;h>=c+parseInt(u,10)?s.scrollLeft=s.scrollLeft+f.clientWidth:p<u&&(s.scrollLeft=s.scrollLeft-f.clientWidth)}}function t(e,l){var t,i=0,r=o.colModel;if("lft"===l)for(i=e+1,t=e;t>=0;t--)if(!0!==r[t].hidden){i=t;break}if("rgt"===l)for(i=e-1,t=e;t<r.length;t++)if(!0!==r[t].hidden){i=t;break}return i}var i,r,a=this,d=e(a),o=a.p,n=a.grid;if(n&&!0===o.cellEdit){var s=n.bDiv;o.knv=o.id+"_kn";var c=e("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+o.knv+"'></div></div>");e(c).insertBefore(n.cDiv),e("#"+o.knv).focus().keydown(function(e){var n=parseInt(o.iRow,10),s=parseInt(o.iCol,10);switch(r=e.keyCode,"rtl"===o.direction&&(37===r?r=39:39===r&&(r=37)),r){case 38:n-1>0&&(l(n-1,s,"vu"),d.jqGrid("editCell",n-1,s,!1));break;case 40:n+1<=a.rows.length-1&&(l(n+1,s,"vd"),d.jqGrid("editCell",n+1,s,!1));break;case 37:s-1>=0&&(l(n,i=t(s-1,"lft"),"h"),d.jqGrid("editCell",n,i,!1));break;case 39:s+1<=o.colModel.length-1&&(l(n,i=t(s+1,"rgt"),"h"),d.jqGrid("editCell",n,i,!1));break;case 13:s>=0&&n>=0&&d.jqGrid("editCell",n,s,!0);break;default:return!0}return!1})}})},getChangedCells:function(t){var r=[];return t||(t="all"),this.each(function(){var a=this,d=a.p,o=l.htmlDecode,n=a.rows;a.grid&&!0===d.cellEdit&&e(n).each(function(l){var s={};if(e(this).hasClass("edited")){var c=this;e(this.cells).each(function(r){var u=d.colModel[r],f=u.name,h=i.call(a,c,r);if("cb"!==f&&"subgrid"!==f&&"rn"!==f&&("dirty"!==t||h.hasClass("dirty-cell")))try{s[f]=e.unformat.call(a,h[0],{rowId:n[l].id,colModel:u},r)}catch(e){s[f]=o(h.html())}}),s.id=this.id,r.push(s)}})}),r}})});
//# sourceMappingURL=grid.celledit.js.map